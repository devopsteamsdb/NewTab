<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Admin - NewTab</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="admin-body">
    <nav class="navbar navbar-fixed">
        <div class="nav-links">
            {% for page in pages %}
            <a href="/?page={{ page.id }}" class="nav-link">{{ page.name }}</a>
            {% endfor %}
            <a href="{{ url_for('admin') }}" class="nav-link active">Admin</a>
        </div>
    </nav>

    <div class="admin-container">
        <!-- ========== CARD FORM ========== -->
        <h2 id="formTitle" class="admin-h2">Add New Card</h2>

        <div class="card-editor-split">
            <div class="card-editor-form">
                <form id="systemForm" action="{{ url_for('add_system') }}" method="POST" enctype="multipart/form-data">
                    <div class="form-group">
                        <label class="admin-label">Use Preset (optional)</label>
                        <input type="text" id="presetSearch" placeholder="Search presets..." class="page-input"
                            style="width: 100%; margin-bottom: 5px;" oninput="filterPresets(this.value)">
                        <select id="presetSelect" class="admin-select" onchange="applyPreset(this.value)">
                            <option value="">-- Custom Card --</option>
                            {% for preset in presets|sort(attribute='name') %}
                            <option value="{{ preset.id }}" data-image="{{ preset.image }}"
                                data-image-mode="{{ preset.image_mode }}" data-image-size="{{ preset.image_size }}"
                                data-back-color="{{ preset.back_color }}" data-front-color="{{ preset.front_color }}"
                                data-name="{{ preset.name }}">
                                {{ preset.name }}{% if preset.builtin %} (built-in){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="admin-label">Card Name</label>
                        <input type="text" name="name" id="nameInput" required oninput="updatePreview()">
                    </div>

                    <div class="form-group">
                        <label class="admin-label">Image (Upload new to replace)</label>
                        <input type="file" name="image_file" accept="image/*" id="fileInput">
                        <div class="paste-area" id="pasteArea" tabindex="0">
                            Click here and Paste (Ctrl+V) an image, or Drag & Drop
                        </div>
                        <input type="hidden" name="pasted_image" id="pastedImage">
                        <input type="hidden" name="preset_image" id="presetImageInput">
                        <div id="preview" class="preview-container"></div>
                    </div>

                    <div class="form-group">
                        <label class="admin-label">Card Back Color</label>
                        <input type="color" name="back_color" id="colorInput" value="#000000" class="color-input"
                            oninput="updatePreview()">
                    </div>

                    <div class="form-group">
                        <label class="admin-label">Image Display Mode</label>
                        <select name="image_mode" id="imageModeInput" class="admin-select"
                            onchange="updatePreview(); toggleFrontColor();">
                            <option value="fill">Fill (cover entire card)</option>
                            <option value="fit">Fit (show full image)</option>
                        </select>
                    </div>

                    <div class="form-group" id="frontColorGroup" style="display: none;">
                        <label class="admin-label">Card Front Color (for fit mode)</label>
                        <input type="color" name="front_color" id="frontColorInput" value="#11161F" class="color-input"
                            oninput="updatePreview()">
                    </div>

                    <div class="form-group" id="imageSizeGroup" style="display: none;">
                        <label class="admin-label">Image Size: <span id="imageSizeValue">80</span>%</label>
                        <input type="range" name="image_size" id="imageSizeInput" min="20" max="100" value="80"
                            class="image-size-input"
                            oninput="document.getElementById('imageSizeValue').textContent = this.value; updatePreview();">
                    </div>

                    <div class="form-group">
                        <label class="admin-label">Assign to Pages</label>
                        <div class="checkbox-group" id="pagesCheckboxes">
                            {% for page in pages %}
                            <label>
                                <input type="checkbox" name="assigned_pages[]" value="{{ page.id }}" {% if
                                    page.id=='default' %}checked{% endif %}>
                                {{ page.name }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="admin-label">Links</label>
                        <div id="linksContainer">
                            <div class="link-row">
                                <input type="text" name="link_text[]" placeholder="Link Text (e.g. Jira)" required
                                    oninput="updatePreview()">
                                <input type="text" name="link_url[]" placeholder="URL (e.g. https://...)" required>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary btn-small" onclick="addLinkRow()">+ Add Another
                            Link</button>
                    </div>

                    <button type="submit" class="btn" id="submitBtn">Add Card</button>
                    <button type="button" class="btn btn-secondary btn-cancel" id="cancelBtn"
                        onclick="cancelEdit()">Cancel Edit</button>
                </form>
            </div>

            <div class="card-editor-preview">
                <div class="preview-label">Live Preview (hover to flip)</div>
                <div class="preview-card">
                    <div class="preview-card-inner">
                        <div class="preview-front">
                            <img id="previewImage" src="{{ url_for('static', filename='generic.png') }}" alt="Preview">
                        </div>
                        <div class="preview-back" id="previewBack">
                            <span id="previewName">Card Name</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr class="admin-hr" style="margin: 40px 0;">

        <!-- ========== CARDS LIST ========== -->
        <h2 class="admin-h2 admin-header-flex">
            Existing Cards
            <input type="text" id="cardFilter" placeholder="Filter cards..." class="filter-input">
        </h2>
        <table class="system-list" id="cardsTable">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Pages</th>
                    <th>Links</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="cardsBody">
                {% for system in systems %}
                <tr class="card-row"
                    data-search="{{ system.name|lower }} {{ system.pages|join(' ')|lower }} {% for l in system.links %}{{ l.text|lower }} {{ l.url|lower }} {% endfor %}">
                    <td>
                        {% if system.image.startswith('presets/') or system.image == 'generic.png' %}
                        <img src="{{ url_for('static', filename=system.image if system.image.startswith('presets/') else 'generic.png') }}"
                            alt="{{ system.name }}" class="table-icon">
                        {% else %}
                        <img src="{{ url_for('uploaded_file', filename=system.image) }}" alt="{{ system.name }}"
                            class="table-icon">
                        {% endif %}
                    </td>
                    <td>{{ system.name }}</td>
                    <td>
                        {% for pid in system.pages %}
                        <span class="tag-badge">{{
                            pid }}</span>
                        {% endfor %}
                    </td>
                    <td>
                        {% for link in system.links %}
                        <div><a href="{{ link.url }}" target="_blank">{{ link.text }}</a></div>
                        {% endfor %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <button type="button" class="btn btn-secondary btn-small btn-xs"
                                onclick="moveCard('up', {{ loop.index0 }})" {% if loop.first %}disabled
                                style="opacity:0.3" {% endif %}>↑</button>
                            <button type="button" class="btn btn-secondary btn-small btn-xs"
                                onclick="moveCard('down', {{ loop.index0 }})" {% if loop.last %}disabled
                                style="opacity:0.3" {% endif %}>↓</button>
                            <button class="btn btn-secondary edit-btn btn-small" data-id="{{ loop.index0 }}"
                                data-name="{{ system.name }}" data-color="{{ system.back_color|default('#000000') }}"
                                data-image="{{ system.image }}"
                                data-image-mode="{{ system.image_mode|default('fill') }}"
                                data-front-color="{{ system.front_color|default('#11161F') }}"
                                data-image-size="{{ system.image_size|default('80') }}"
                                data-links='{{ system.links|tojson|e }}'
                                data-pages='{{ system.pages|tojson|e }}'>Edit</button>
                            <form action="{{ url_for('delete_system', id=loop.index0) }}" method="POST"
                                class="inline-form" onsubmit="return confirm('Delete this card?');">
                                <button type="submit" class="btn btn-danger btn-small">Delete</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Pagination -->
        <div id="pagination" style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;"></div>

        <hr class="admin-hr" style="margin: 40px 0;">

        <!-- ========== PAGE MANAGEMENT ========== -->
        <h2 class="admin-h2">Manage Pages</h2>
        <form action="{{ url_for('add_page') }}" method="POST" class="page-form">
            <input type="text" name="page_name" placeholder="New page name (e.g. DevOps)" required class="page-input">
            <button type="submit" class="btn btn-small">Add Page</button>
        </form>
        <div class="page-list">
            {% for page in pages %}
            <div class="page-item {% if page.id == 'default' %}default{% endif %}">
                <span>{{ page.name }}</span>
                {% if page.id != 'default' %}
                <form action="{{ url_for('delete_page', page_id=page.id) }}" method="POST" class="inline-form"
                    onsubmit="return confirm('Delete page {{ page.name }}?');">
                    <button type="submit" class="btn btn-danger btn-small btn-xs">×</button>
                </form>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <hr class="admin-hr">

        <!-- ========== SEARCH SETTINGS ========== -->
        <h2 class="admin-h2">Search Bar Settings</h2>
        <form action="{{ url_for('update_settings') }}" method="POST" class="settings-form">
            <label class="checkbox-label">
                <input type="checkbox" name="search_enabled" {% if settings.search_enabled %}checked{% endif %}
                    class="checkbox-input-large">
                Enable Search Bar
            </label>
            <input type="text" name="search_placeholder" value="{{ settings.search_placeholder }}"
                placeholder="Placeholder (e.g. Google Search)" class="settings-input-flex">
            <div class="input-group-row">
                <input type="number" name="search_width" value="{{ settings.search_width }}" placeholder="Width"
                    class="input-width">
                <span class="text-muted">px</span>
            </div>
            <input type="text" name="search_base_url" value="{{ settings.search_base_url }}"
                placeholder="Search Base URL (e.g. https://www.google.com/search?q=)" class="settings-input-large">
            <button type="submit" class="btn btn-small">Save Settings</button>
        </form>

        <hr class="admin-hr">

        <!-- ========== FOOTER SETTINGS ========== -->
        <h2 class="admin-h2">Footer Settings</h2>
        <form action="{{ url_for('update_settings') }}" method="POST" class="settings-form">
            <input type="hidden" name="search_enabled" value="{{ 'on' if settings.search_enabled else '' }}">
            <input type="hidden" name="search_base_url" value="{{ settings.search_base_url }}">
            <input type="hidden" name="search_placeholder" value="{{ settings.search_placeholder }}">
            <input type="hidden" name="search_width" value="{{ settings.search_width }}">
            <input type="text" name="footer_text"
                value="{{ settings.footer_text|default('Made with Love by DevOps Team') }}" placeholder="Footer text"
                class="settings-input-large-text">
            <button type="submit" class="btn btn-small">Save Footer</button>
        </form>
    </div>

    <script>
        // ========== LIVE PREVIEW ==========
        let previewPage = 0;

        function filterPresets(query) {
            const select = document.getElementById('presetSelect');
            const options = select.options;
            const q = query.toLowerCase();
            let firstMatchIndex = -1;

            for (let i = 0; i < options.length; i++) {
                const option = options[i];
                const text = option.text.toLowerCase();

                // Always keep "Custom Card" visible
                if (option.value === "") {
                    option.style.display = "";
                    if (q === "") firstMatchIndex = i;
                } else {
                    if (text.includes(q)) {
                        option.style.display = "";
                        if (firstMatchIndex === -1) firstMatchIndex = i;
                    } else {
                        option.style.display = "none";
                    }
                }
            }

            // Auto-select the first visible match
            if (firstMatchIndex !== -1) {
                select.selectedIndex = firstMatchIndex;
                applyPreset(select.options[firstMatchIndex].value);
            } else {
                // No match, maybe reset to custom? or keep previous?
                // Letting it stay on previous or custom is safer.
                // But usually if no match, we might want to reset.
                // For now, let's reset to custom if search has no results
                if (select.value !== "") {
                    select.value = "";
                    applyPreset("");
                }
            }
        }

        function toggleFrontColor() {
            const mode = document.getElementById('imageModeInput').value;
            const isFit = mode === 'fit';
            document.getElementById('frontColorGroup').style.display = isFit ? 'block' : 'none';
            document.getElementById('imageSizeGroup').style.display = isFit ? 'block' : 'none';
        }

        function applyPreset(presetId) {
            if (!presetId) {
                // Custom card selected - reset form
                document.getElementById('nameInput').value = '';
                document.getElementById('colorInput').value = '#000000';
                document.getElementById('imageModeInput').value = 'fill';
                document.getElementById('frontColorInput').value = '#11161F';
                document.getElementById('imageSizeInput').value = '80';
                document.getElementById('imageSizeValue').textContent = '80';
                document.getElementById('previewImage').src = '/static/generic.png';
                document.getElementById('presetImageInput').value = '';
                document.getElementById('pastedImage').value = '';
                document.getElementById('fileInput').value = '';
                document.getElementById('preview').innerHTML = '';
                document.getElementById('linksContainer').innerHTML = '';
                addLinkRow();
                toggleFrontColor();
                updatePreview();
                return;
            }

            const select = document.getElementById('presetSelect');
            const option = select.options[select.selectedIndex];

            // Get preset data from option attributes
            const name = option.dataset.name;
            const image = option.dataset.image;
            const imageMode = option.dataset.imageMode;
            const imageSize = option.dataset.imageSize;
            const backColor = option.dataset.backColor;
            const frontColor = option.dataset.frontColor;

            // Apply to form fields
            document.getElementById('nameInput').value = name;
            document.getElementById('colorInput').value = backColor;
            document.getElementById('imageModeInput').value = imageMode;
            document.getElementById('frontColorInput').value = frontColor;
            document.getElementById('imageSizeInput').value = imageSize;
            document.getElementById('imageSizeValue').textContent = imageSize;

            // Set preset image
            const imgUrl = '/static/' + image;
            document.getElementById('previewImage').src = imgUrl;
            document.getElementById('presetImageInput').value = image;

            // Clear any uploaded image
            document.getElementById('pastedImage').value = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('preview').innerHTML = '';

            // Show/hide fit mode options
            toggleFrontColor();
            updatePreview();
        }

        function updatePreview() {
            const name = document.getElementById('nameInput').value || 'Card Name';
            const color = document.getElementById('colorInput').value || '#000000';
            const imageMode = document.getElementById('imageModeInput').value || 'fill';
            const frontColor = document.getElementById('frontColorInput').value || '#11161F';
            const imageSize = document.getElementById('imageSizeInput').value || '80';
            const previewBack = document.getElementById('previewBack');
            const previewImage = document.getElementById('previewImage');
            const previewFront = document.querySelector('.preview-front');

            // Update front color and image mode
            previewFront.style.backgroundColor = frontColor;
            if (imageMode === 'fit') {
                previewImage.style.objectFit = 'contain';
                previewImage.style.width = imageSize + '%';
                previewImage.style.height = imageSize + '%';
            } else {
                previewImage.style.objectFit = 'cover';
                previewImage.style.width = '100%';
                previewImage.style.height = '100%';
            }

            // Update back color
            previewBack.style.backgroundColor = color;

            // Update name or links
            const linkInputs = document.querySelectorAll('input[name="link_text[]"]');
            const linkTexts = Array.from(linkInputs).map(i => i.value).filter(v => v.trim());

            if (linkTexts.length <= 1) {
                previewBack.innerHTML = `<span>${name}</span>`;
            } else if (linkTexts.length > 4) {
                // Paginated view with arrows
                const perPage = 4;
                const totalPages = Math.ceil(linkTexts.length / perPage);
                previewPage = Math.min(previewPage, totalPages - 1);
                const start = previewPage * perPage;
                const end = start + perPage;
                const visibleLinks = linkTexts.slice(start, end);

                let html = `<div class="preview-paginated">`;
                html += `<button class="preview-nav" onclick="event.stopPropagation(); previewPaginate(-1);" ${previewPage === 0 ? 'disabled' : ''}>‹</button>`;
                html += `<div class="preview-links-list">`;
                visibleLinks.forEach(t => html += `<a href="#">${t}</a>`);
                html += `</div>`;
                html += `<button class="preview-nav" onclick="event.stopPropagation(); previewPaginate(1);" ${previewPage >= totalPages - 1 ? 'disabled' : ''}>›</button>`;
                html += `</div>`;
                previewBack.innerHTML = html;
            } else {
                let linksHtml = linkTexts.map(t => `<a href="#">${t}</a>`).join('');
                previewBack.innerHTML = linksHtml;
            }

            // Update preview image if pasted
            const pastedImage = document.getElementById('pastedImage').value;
            if (pastedImage) {
                previewImage.src = pastedImage;
            }
        }

        function previewPaginate(dir) {
            previewPage += dir;
            updatePreview();
        }

        function addLinkRow(text = '', url = '') {
            const container = document.getElementById('linksContainer');
            const div = document.createElement('div');
            div.className = 'link-row';
            div.innerHTML = `
                <input type="text" name="link_text[]" placeholder="Link Text" value="${text}" required oninput="updatePreview()">
                <input type="text" name="link_url[]" placeholder="URL" value="${url}" required>
                <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.remove(); updatePreview();">×</button>
            `;
            container.appendChild(div);
            updatePreview();
        }

        function editSystem(btn) {
            const id = btn.dataset.id;
            const name = btn.dataset.name;
            const color = btn.dataset.color;
            const image = btn.dataset.image;
            const imageMode = btn.dataset.imageMode || 'fill';
            const frontColor = btn.dataset.frontColor || '#11161F';
            const imageSize = btn.dataset.imageSize || '80';
            const links = JSON.parse(btn.dataset.links);
            const pages = JSON.parse(btn.dataset.pages);

            document.getElementById('formTitle').scrollIntoView({ behavior: 'smooth' });

            document.getElementById('formTitle').innerText = 'Edit Card';
            document.getElementById('submitBtn').innerText = 'Update Card';
            document.getElementById('cancelBtn').style.display = 'inline-block';

            const form = document.getElementById('systemForm');
            form.action = '/admin/update/' + id;

            document.getElementById('nameInput').value = name;
            document.getElementById('colorInput').value = color;
            document.getElementById('imageModeInput').value = imageMode;
            document.getElementById('frontColorInput').value = frontColor;
            document.getElementById('imageSizeInput').value = imageSize;
            document.getElementById('imageSizeValue').textContent = imageSize;
            toggleFrontColor();

            // Set page checkboxes
            document.querySelectorAll('#pagesCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = pages.includes(cb.value);
            });

            // Fill links
            const container = document.getElementById('linksContainer');
            container.innerHTML = '';
            if (links && links.length > 0) {
                links.forEach(link => addLinkRow(link.text, link.url));
            } else {
                addLinkRow();
            }

            // Load existing image to preview
            // First clear any previously uploaded/pasted image
            document.getElementById('pastedImage').value = '';
            document.getElementById('preview').innerHTML = '';
            document.getElementById('pasteArea').innerText = "Click here and Paste (Ctrl+V) an image, or Drag & Drop";
            document.getElementById('fileInput').value = '';

            if (image) {
                let imagePath;
                if (image === 'generic.png') {
                    imagePath = "/static/generic.png";
                } else if (image.startsWith('presets/')) {
                    imagePath = "/static/" + image;
                } else {
                    imagePath = "/uploads/" + image;
                } document.getElementById('previewImage').src = imagePath;
            }

            // Update preview back color
            document.getElementById('previewBack').style.backgroundColor = color;
            previewPage = 0;
            updatePreview();
        }

        function cancelEdit() {
            document.getElementById('formTitle').innerText = 'Add New Card';
            document.getElementById('submitBtn').innerText = 'Add Card';
            document.getElementById('cancelBtn').style.display = 'none';

            const form = document.getElementById('systemForm');
            form.action = "{{ url_for('add_system') }}";
            form.reset();

            // Reset checkboxes to default only
            document.querySelectorAll('#pagesCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = cb.value === 'default';
            });

            document.getElementById('linksContainer').innerHTML = '';
            addLinkRow();
            document.getElementById('preview').innerHTML = '';
            document.getElementById('pastedImage').value = '';
            document.getElementById('pasteArea').innerText = "Click here and Paste (Ctrl+V) an image, or Drag & Drop";

            // Reset image mode and front color
            document.getElementById('imageModeInput').value = 'fill';
            document.getElementById('frontColorInput').value = '#11161F';
            document.getElementById('imageSizeInput').value = '80';
            document.getElementById('imageSizeValue').textContent = '80';
            toggleFrontColor();

            // Reset preview card
            document.getElementById('previewImage').src = '/static/generic.png';
            document.getElementById('previewBack').style.backgroundColor = '#000000';
            previewPage = 0;
            updatePreview();
        }

        // ========== FILTER & PAGINATION ==========
        const ITEMS_PER_PAGE = 10;
        let currentPage = 1;
        let allRows = [];
        let filteredRows = [];

        function initPagination() {
            allRows = Array.from(document.querySelectorAll('.card-row'));
            filteredRows = allRows;
            renderPage();
        }

        function filterCards(query) {
            const q = query.toLowerCase();
            filteredRows = allRows.filter(row => row.dataset.search.includes(q));
            currentPage = 1;
            renderPage();
        }

        function renderPage() {
            // Hide all rows
            allRows.forEach(row => row.style.display = 'none');

            // Show filtered rows for current page
            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            filteredRows.slice(start, end).forEach(row => row.style.display = '');

            renderPaginationControls();
        }

        function renderPaginationControls() {
            const totalPages = Math.ceil(filteredRows.length / ITEMS_PER_PAGE);
            const container = document.getElementById('pagination');
            container.innerHTML = '';

            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.className = 'btn btn-small' + (i === currentPage ? '' : ' btn-secondary');
                btn.innerText = i;
                btn.onclick = () => { currentPage = i; renderPage(); };
                container.appendChild(btn);
            }
        }

        function bindEvents() {
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => editSystem(btn));
            });
            initPagination();
        }

        // Move Card Logic (AJAX)
        async function moveCard(direction, id) {
            try {
                // Determine the correct URL based on backend route
                const url = `/admin/move/${direction}/${id}`;

                // Fetch follows redirect automatically by default
                const response = await fetch(url, { method: 'POST' });

                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    // Replace the table body
                    const newBody = doc.getElementById('cardsBody');
                    document.getElementById('cardsBody').innerHTML = newBody.innerHTML;

                    // Re-bind events and pagination
                    // We also need to preserve the current search filter if any
                    const currentFilter = document.getElementById('cardFilter').value;
                    bindEvents();

                    if (currentFilter) {
                        filterCards(currentFilter);
                    }
                }
            } catch (error) {
                console.error('Error moving card:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            bindEvents();

            // Init filter
            const filterInput = document.getElementById('cardFilter');
            if (filterInput) {
                filterInput.addEventListener('input', (e) => filterCards(e.target.value));
            }
        });

        // Paste Image Logic
        const pasteArea = document.getElementById('pasteArea');
        const preview = document.getElementById('preview');
        const hiddenInput = document.getElementById('pastedImage');
        const fileInput = document.getElementById('fileInput');

        // File input change handler
        fileInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                handleImage(e.target.files[0]);
            }
        });

        pasteArea.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let item of items) {
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    handleImage(item.getAsFile());
                }
            }
        });

        pasteArea.addEventListener('dragover', (e) => { e.preventDefault(); pasteArea.classList.add('active'); });
        pasteArea.addEventListener('dragleave', () => pasteArea.classList.remove('active'));
        pasteArea.addEventListener('drop', (e) => {
            e.preventDefault();
            pasteArea.classList.remove('active');
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                handleImage(e.dataTransfer.files[0]);
            }
        });

        function handleImage(blob) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const dataUrl = event.target.result;
                preview.innerHTML = `<img src="${dataUrl}" style="max-height: 100px; border: 1px solid #ccc;">`;
                hiddenInput.value = dataUrl;
                pasteArea.innerText = "Image captured!";
                // Directly update preview card image
                document.getElementById('previewImage').src = dataUrl;
            };
            reader.readAsDataURL(blob);
        }
    </script>
</body>

</html>